<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Admin — SourceMarket</title>
    <link rel="stylesheet" href="styles.css">
    <style>
      .admin-header{padding:18px 24px;border-bottom:1px solid var(--border);background:var(--surface)}
      .admin-main{padding:24px}
      .pad{padding:12px}
      .input-inline{display:flex;gap:8px;align-items:center}
      .file-list{margin-top:14px}
      .file-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #eee}
      .small-muted{font-size:.9rem;color:var(--muted)}
    </style>
  </head>
  <body>
    <header class="admin-header">
      <div class="container header-row">
        <div><strong>SourceMarket — Admin</strong><div class="small-muted">Manage courses & listings (no server required)</div></div>
        <div class="input-inline">
          <input id="patInput" type="password" placeholder="Paste GitHub PAT here" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
          <button id="authBtn" class="btn btn-primary">Authorize</button>
        </div>
      </div>
    </header>

    <main class="admin-main container">
      <section>
        <h3>Courses</h3>
        <div class="pad">
          <button id="newCourse" class="btn">Add new course</button>
          <div id="coursesList" class="file-list"></div>
        </div>
      </section>

      <!-- Course / Listing edit modal -->
      <div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(11,18,32,0.6);align-items:center;justify-content:center">
        <div style="background:#fff;padding:18px;border-radius:10px;min-width:320px;max-width:720px;box-shadow:0 12px 30px rgba(11,18,32,0.12)">
          <h3 id="modalTitle">Edit</h3>
          <form id="editForm">
            <input type="hidden" id="editPath">
            <label>Id
              <input id="fieldId" required style="width:100%;padding:8px;margin-top:6px;border:1px solid var(--border);border-radius:8px">
            </label>
            <label>Title
              <input id="fieldTitle" required style="width:100%;padding:8px;margin-top:6px;border:1px solid var(--border);border-radius:8px">
            </label>
            <label>Short description
              <textarea id="fieldShort" style="width:100%;padding:8px;margin-top:6px;border:1px solid var(--border);border-radius:8px"></textarea>
            </label>
            <label>Full description
              <textarea id="fieldFull" style="width:100%;padding:8px;margin-top:6px;border:1px solid var(--border);border-radius:8px"></textarea>
            </label>
            <label>Image URL (or upload below)
              <input id="fieldImage" style="width:100%;padding:8px;margin-top:6px;border:1px solid var(--border);border-radius:8px">
            </label>
            <label>Upload image
              <input id="imageUpload" type="file" accept="image/*" style="margin-top:6px">
            </label>
            <label style="display:block;margin-top:8px"><input id="fieldPublished" type="checkbox"> Published</label>
            <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
              <button type="button" id="saveBtn" class="btn btn-primary">Save</button>
              <button type="button" id="cancelBtn" class="btn">Cancel</button>
            </div>
          </form>
        </div>
      </div>

      <section style="margin-top:28px">
        <h3>Listings (Garments)</h3>
        <div class="pad">
          <button id="newListing" class="btn">Add listing</button>
          <div id="listingsList" class="file-list"></div>
        </div>
      </section>

      <section style="margin-top:28px">
        <h3>Help & Notes</h3>
        <div class="pad small-muted">
          - This admin uses GitHub REST API to create/update files under <code>/data/</code> and uploads images to <code>/assets/images/</code> when you choose to upload.
          <br>- To authorize: generate a Personal Access Token (classic) with <code>repo</code> scope and paste it above. The token stays in your browser session only.
          <br>- I will not collect or store your token.
        </div>
      </section>
    </main>

    <script>
      // Basic GitHub file operations using PAT stored in memory
      const owner = 'munna1234mm';
      const repo = 'okokokokokokok';
      let headers = {};

      function setAuth(token){
        headers = { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' };
      }

      async function listFiles(path){
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const res = await fetch(url, { headers });
        if(res.status===200) return res.json();
        return [];
      }

      async function getFile(path){
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const res = await fetch(url,{headers});
        if(res.status===200)return res.json();
        return null;
      }

      async function putFile(path, content, message){
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const body = { message, content: btoa(unescape(encodeURIComponent(content))) };
        // Try to get existing file to include sha when updating
        const existing = await getFile(path);
        if(existing && existing.sha) body.sha = existing.sha;
        const res = await fetch(url, { method: 'PUT', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        return res.json();
      }

      // Upload binary (base64) content directly (useful for images)
      async function putFileBase64(path, base64Content, message){
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const body = { message, content: base64Content };
        const existing = await getFile(path);
        if(existing && existing.sha) body.sha = existing.sha;
        const res = await fetch(url, { method: 'PUT', headers: { ...headers, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        return res.json();
      }

      async function deleteFile(path, message){
        const existing = await getFile(path);
        if(!existing) return null;
        const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
        const body = { message, sha: existing.sha };
        const res = await fetch(url, { method: 'DELETE', headers: {...headers, 'Content-Type':'application/json'}, body: JSON.stringify(body) });
        return res.json();
      }

      // Render lists
      async function renderCourses(){
        const list = document.getElementById('coursesList'); list.innerHTML='Loading...';
        const files = await listFiles('data/courses').catch(()=>[]);
        list.innerHTML = '';
        if(!files || files.length===0){ list.innerHTML = '<div class="small-muted">No courses found</div>'; return; }
        files.forEach(f=>{
          const row = document.createElement('div'); row.className='file-row';
          const left = document.createElement('div'); left.innerHTML = `<strong>${f.name}</strong>`;
          const right = document.createElement('div');
          right.innerHTML = `<button class="btn" onclick="previewFile('${f.path}')">Preview</button> <button class="btn" data-path="${f.path}" onclick="editCourse('${f.path}')">Edit</button> <button class="btn" data-path="${f.path}" onclick="removeCourse('${f.path}')">Delete</button>`;
          row.appendChild(left); row.appendChild(right); list.appendChild(row);
        });
      }

      async function renderListings(){
        const list = document.getElementById('listingsList'); list.innerHTML='Loading...';
        const files = await listFiles('data/listings').catch(()=>[]);
        list.innerHTML = '';
        if(!files || files.length===0){ list.innerHTML = '<div class="small-muted">No listings found</div>'; return; }
        files.forEach(f=>{
          const row = document.createElement('div'); row.className='file-row';
          const left = document.createElement('div'); left.innerHTML = `<strong>${f.name}</strong>`;
          const right = document.createElement('div');
          right.innerHTML = `<button class="btn" onclick="previewFile('${f.path}')">Preview</button> <button class="btn" data-path="${f.path}" onclick="editListing('${f.path}')">Edit</button> <button class="btn" data-path="${f.path}" onclick="removeListing('${f.path}')">Delete</button>`;
          row.appendChild(left); row.appendChild(right); list.appendChild(row);
        });
      }

      // State for modal and uploads
      let currentUploadFile = null;
      let currentEditingPath = null;
      let currentEditingType = null;

      function showEditModal(type, path, data){
        currentEditingType = type; currentEditingPath = path;
        document.getElementById('modalTitle').innerText = type === 'course' ? 'Edit Course' : 'Edit Listing';
        document.getElementById('editPath').value = path;
        document.getElementById('fieldId').value = data.id || '';
        document.getElementById('fieldTitle').value = data.title || '';
        document.getElementById('fieldShort').value = data.short_description || data.description || '';
        document.getElementById('fieldFull').value = data.full_description || data.description || '';
        document.getElementById('fieldImage').value = (data.image || (data.images && data.images[0]) || '');
        document.getElementById('fieldPublished').checked = !!data.published;
        currentUploadFile = null;
        document.getElementById('imageUpload').value = '';
        document.getElementById('editModal').style.display = 'flex';
      }

      function hideEditModal(){ document.getElementById('editModal').style.display = 'none'; }

      window.editCourse = async function(path){
        const f = await getFile(path);
        if(!f) return alert('Unable to load file');
        const content = decodeURIComponent(escape(atob(f.content)));
        const data = JSON.parse(content);
        showEditModal('course', path, data);
      }

      window.removeCourse = async function(path){ if(!confirm('Delete this course?')) return; await deleteFile(path, 'Delete course'); alert('Deleted'); renderCourses(); }

      window.editListing = async function(path){
        const f = await getFile(path);
        if(!f) return alert('Unable to load file');
        const content = decodeURIComponent(escape(atob(f.content)));
        const data = JSON.parse(content);
        showEditModal('listing', path, data);
      }

      window.removeListing = async function(path){ if(!confirm('Delete this listing?')) return; await deleteFile(path,'Delete listing'); alert('Deleted'); renderListings(); }

      document.getElementById('authBtn').addEventListener('click', ()=>{
        const token = document.getElementById('patInput').value.trim(); if(!token) return alert('Paste your GitHub PAT'); setAuth(token); renderCourses(); renderListings(); alert('Authorized (in this browser session only)');
      });

      document.getElementById('newCourse').addEventListener('click', async ()=>{
        const id = prompt('Course ID (slug) e.g. intro-to-fashion-tech'); if(!id) return;
        const title = prompt('Title'); if(!title) return;
        const data = { id, title, short_description:'', full_description:'', image:'', category:'Garments', price:0, published:false, created_at:new Date().toISOString() };
        await putFile(`data/courses/${id}.json`, JSON.stringify(data, null, 2), `Add course ${id}`);
        alert('Course created'); renderCourses();
      });

      document.getElementById('newListing').addEventListener('click', async ()=>{
        const id = prompt('Listing ID (slug) e.g. sample-listing'); if(!id) return;
        const title = prompt('Title'); if(!title) return;
        const data = { id, title, description:'', images:[], tags:[], price:0, published:false };
        await putFile(`data/listings/${id}.json`, JSON.stringify(data, null, 2), `Add listing ${id}`);
        alert('Listing created'); renderListings();
      });

      // Preview helper
      window.previewFile = function(path){
        const raw = `https://raw.githubusercontent.com/${owner}/${repo}/main/${path}`;
        window.open(raw, '_blank');
      }

      // Modal buttons and upload handling
      document.getElementById('cancelBtn').addEventListener('click', ()=>{ hideEditModal(); });
      document.getElementById('saveBtn').addEventListener('click', async ()=>{
        const path = document.getElementById('editPath').value;
        if(!path) return alert('Missing path');
        // build data object from fields
        const id = document.getElementById('fieldId').value.trim();
        const title = document.getElementById('fieldTitle').value.trim();
        const shortDesc = document.getElementById('fieldShort').value.trim();
        const fullDesc = document.getElementById('fieldFull').value.trim();
        let image = document.getElementById('fieldImage').value.trim();
        const published = document.getElementById('fieldPublished').checked;

        // If a file was selected, upload it to assets/images
        if(currentUploadFile){
          const fname = (id || 'upload') + '_' + Date.now() + '.' + currentUploadFile.name.split('.').pop();
          const reader = new FileReader();
          reader.onload = async function(ev){
            const dataUrl = ev.target.result; // data:image/png;base64,....
            const base64 = dataUrl.split(',')[1];
            await putFileBase64(`assets/images/${fname}`, base64, `Add image ${fname}`);
            image = `/assets/images/${fname}`;
            await saveMeta();
          }
          reader.readAsDataURL(currentUploadFile);
        } else {
          await saveMeta();
        }

        async function saveMeta(){
          // load existing json to preserve fields
          const f = await getFile(path);
          const content = f ? decodeURIComponent(escape(atob(f.content))) : '{}';
          const data = Object.assign({}, JSON.parse(content));
          data.id = id || data.id || path.split('/').pop().replace('.json','');
          data.title = title;
          if(shortDesc) data.short_description = shortDesc;
          if(fullDesc) data.full_description = fullDesc;
          if(image) data.image = image;
          data.published = !!published;
          await putFile(path, JSON.stringify(data, null, 2), `Update ${data.id}`);
          alert('Saved'); hideEditModal();
          if(currentEditingType==='course') renderCourses(); else renderListings();
        }
      });

      document.getElementById('imageUpload').addEventListener('change', (e)=>{ currentUploadFile = e.target.files[0] || null; });

      // initial empty lists until authorized
    </script>
  </body>
</html>